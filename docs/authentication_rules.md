# 인증(Authentication) 정책 및 구현 규칙 v1.0

이 문서는 프로젝트의 인증 로직, 세션 관리, 데이터 로딩에 대한 **절대적인 규칙**을 정의합니다.
개발자는 이 문서를 기준으로 기능을 구현하며, 임의로 로직을 우회하거나 "사용자 편의"를 위해 타협하지 않습니다.

---

## 1. 기본 원칙 (Core Principles)

1.  **DB 정보 절대주의 (Single Source of Truth)**

    - **사용자 정보(닉네임, 역할, 프로필 이미지 등)는 오직 Supabase DB(`users` 테이블)에서만 가져옵니다.**
    - Google 등 소셜 로그인 provider가 제공하는 메타데이터(`user_metadata`)는 인증 수단일 뿐, 프로필 정보로 사용하지 않습니다.
    - DB에 정보가 없다면 "정보 없음" 또는 "에러"로 처리하며, 임의로 데이터를 만들거나 메타데이터를 보여주지 않습니다.

2.  **브라우저 캐시(Local Storage) 의존 금지**

    - **사용자 데이터 캐싱 금지**: `userRole`, `userNickname` 등 사용자 정보를 Local Storage에 저장하지 않습니다.
    - **상태 비동기화 방지**: 새로고침 시 무조건 DB에서 최신 정보를 다시 가져옵니다. "이전 기록"을 믿지 않습니다.
    - _예외_: 오직 '세션 만료 체크'를 위한 `lastActivity` 타임스탬프 정도만 최소한으로 허용합니다.

3.  **즉각적인 상태 반영 (No Delays)**
    - **인공적인 지연 제거**: 로딩 스피너를 보여주기 위해, 또는 "안전을 위해" 넣었던 `setTimeout` (3초, 5초 대기 등)을 모두 제거합니다.
    - 데이터가 오면 오는 대로, 없으면 없는 대로 즉시 UI에 반영합니다.

---

## 2. 로그인 (Login) 프로세스

1.  **진입**: 사용자가 이메일 또는 소셜 로그인을 시도합니다.
2.  **인증 확인**: Supabase Auth가 세션을 반환합니다.
3.  **데이터 로딩**:
    - 세션이 확인되는 **즉시** `users` 테이블을 조회합니다.
    - 조회된 데이터로 앱의 전역 User Context를 업데이트합니다.
4.  **완료**:
    - 이 모든 과정은 멈춤 없이(Blocking 없이) 물 흐르듯 진행되어야 합니다.
    - 로딩 중에는 스켈레톤/스피너를 표시하되, 인위적으로 시간을 끌지 않습니다.

---

## 3. 로그아웃 (Logout) 프로세스

1.  **트리거**: 사용자가 로그아웃 버튼을 클릭하거나, 세션이 만료됩니다.
2.  **즉시 파기**:
    - 브라우저에 남아있는 모든 인증 관련 State를 `null`로 만듭니다.
    - Supabase의 `signOut()`을 호출하여 서버 세션을 닫습니다.
    - **가차 없이 초기화**: "혹시 모르니 남겨두자"는 없습니다. 깨끗하게 비웁니다.
3.  **새 접속 처리**:
    - 로그아웃 후(또는 세션 만료 후) 접속 시, **무조건 로그인/회원가입 버튼**이 보여야 합니다.
    - "이전에 로그인했음"을 기억해서 애매하게 아바타를 보여주려 하지 않습니다.

---

## 4. 세션 관리 (Session Management)

1.  **30분 타임아웃 규칙**:

    - 사용자가 로그아웃을 **직접 하지 않았더라도**, 마지막 활동 이후 **30분**이 지나면 자동으로 로그아웃 처리합니다.
    - 이를 위해 '마직막 활동 시간'을 기록하고, 앱 초기화 시 이 시간을 체크합니다.
    - 시간이 초과되었다면? -> **즉시 로그아웃 프로세스 실행**. 봐주지 않습니다.

2.  **새로고침/재접속 시**:
    - 항상 DB에서 최신 상태를 확인합니다.
    - 세션이 유효하고 시간 내라면 -> 로그인 유지.
    - 세션이 없거나 시간이 지났다면 -> 로그인 풀림.

---

## 5. 예외 상황 처리

- **DB 연결 실패 시**: 로그인을 거부하거나 "일시적인 오류"를 표시합니다. 억지로 로그인된 척하지 않습니다.
- **소셜 로그인 콜백 멈춤**: 콜백 페이지(`auth/callback`)는 인증 이벤트를 감지하면 **즉시** 메인으로 이동해야 합니다. 5초, 7초 기다리는 안전장치는 삭제합니다. 이벤트가 발생하면 바로 이동합니다.

---

**작성일**: 2026-01-02
**적용 대상**: `AuthContext.tsx`, `AuthButtons.tsx`, `auth/callback/page.tsx`
